<template>
<uni-shadow-root class="lin-ui-dist-image-picker-index"><view class="lin-image-picker__container l-class">
  <block v-for="(item,index) in (value)" :key="item.index">
    <view :class="'lin-image-picker__item lin-image-picker__item--'+(size)" :style="itemSizePercentage?'width:'+itemSizePercentage+'padding-bottom:'+itemSizePercentage:'xxx'">
      <image mut-bind:tap="onTapImage" :data-image-index="index" :src="item" :mode="mode" class="lin-image-picker__image"></image>
      <view mut-bind:tap="onTapRemove" class="lin-image-picker__remove" :data-image-index="index">
        <l-icon name="close" color="#ffffff" size="18"></l-icon>
      </view>
    </view>
  </block>
  
  <view v-if="count-value.length>0" mut-bind:tap="onTapAdd" :class="'lin-image-picker__item lin-image-picker__item--add lin-image-picker__item--'+(size)" :style="itemSizePercentage?'width:'+itemSizePercentage+'padding-bottom:'+itemSizePercentage:''">
    <view class="lin-image-picker__item-slot-wrapper">
      <slot></slot>
    </view>
    <image src="./image/add.png" class="lin-image-picker__image--add"></image>
  </view>
</view></uni-shadow-root>
</template>

<script>
import LIcon from '../icon/index.vue'
global['__wxVueOptions'] = {components:{'l-icon': LIcon}}

global['__wxRoute'] = 'lin-ui/dist/image-picker/index'
import nodeUtil from"../core/utils/node-util";import deviceUtil from"../utils/device-util";import eventUtil from"../core/utils/event-util";import{promisic}from"../utils/util";Component({options:{pureDataPattern:/urls|cells|preview|remove|sizeType|maxImageSize|clear/},behaviors:["wx://form-field"],externalClasses:["l-class","l-item-class"],properties:{urls:{type:Array,value:null},cells:{type:Array,value:null},size:{type:Number,value:null},mode:{type:String,value:"aspectFit"},preview:{type:Boolean,value:!0},remove:{type:Boolean,value:!0},count:{type:Number,value:9},sizeType:{type:Array|String,value:["original","compressed"]},maxImageSize:{type:Number,value:0},clear:{type:Boolean,value:!1},custom:{type:Boolean,value:!1},value:{type:Array,value:[]}},data:{itemSizePercentage:null},observers:{clear(e){e&&(console.warn("clear 属性已废弃，请使用 linClearImage 函数 或 urls 属性清空图片\n 详情信息参考："),this.setData({value:[],clear:!1}))},"urls,cells":function(e,t){if(!e&&!t)return;let a=[];if(e)a=e;else if(t)for(const e of t)Object.prototype.hasOwnProperty.call(e,"url")&&a.push(e.url);this.setData({value:a.slice(0,this.data.count)})},async size(e){if(!e)return void this.setData({itemSizePercentage:null});const t=await nodeUtil.getNodeRectFromComponent(this,".lin-image-picker__container"),a=10/e*10-20/deviceUtil.px2rpx(t.right-t.left)*100+"%;";this.setData({itemSizePercentage:a})},custom(e){e&&console.warn("custom 已弃用，请勿使用该属性，直接传入 slot 即可")}},methods:{onTapImage(e){const t=this,a=this.data.value,i=e.currentTarget.dataset.imageIndex,l=a[i],r={all:a,index:i,current:l};eventUtil.emit(this,"lintap",r),this.data.preview&&wx.previewImage({urls:a,current:l,success(){eventUtil.emit(t,"linpreview",r)}},!0)},onTapRemove(e){const t=this.data.value,a=e.currentTarget.dataset.imageIndex,i={all:t,index:a,current:t[a]};eventUtil.emit(this,"linremovetap",i),this.data.remove&&this._removeImageByIndex(a)},async onTapAdd(){let{value:e,count:t,sizeType:a,maxImageSize:i}=this.data;const l=t-e.length;if(e.length>=t||l<=0)return;const r=await promisic(wx.chooseImage)({count:l,sizeType:a,sourceType:["album","camera"]}),s=[],n=[];r.tempFiles.forEach(e=>{const{path:t,size:a}=e;a>i&&i>0?n.push(t):s.push(t)}),this.setData({value:e.concat(s)},()=>{const e={all:this.data.value,current:s,oversize:n};eventUtil.emit(this,"linadd",e),eventUtil.emit(this,"linchange",e),eventUtil.emit(this,"linoversize",e)})},getValues(){return this.data.value},_removeImageByIndex(e){const t=this.data.value,a=t[e];t.splice(e,1);const i={index:e,current:a,all:t};this.setData({value:t},()=>{eventUtil.emit(this,"linremove",i)})},linRemoveImage(e){this._removeImageByIndex(e)},linClearImage(){this.setData({value:[]})},linGetValue(){return this.data.value}}});
export default global['__wxComponents']['lin-ui/dist/image-picker/index']
</script>
<style platform="mp-weixin">
.lin-image-picker__container{position:relative;display:flex;flex-wrap:wrap}.lin-image-picker__item{position:relative;width:220rpx;padding-bottom:220rpx;height:0}.lin-image-picker__item--2:nth-of-type(n+3){margin-top:20rpx}.lin-image-picker__item--2:not(:nth-of-type(2n+1)){margin-left:20rpx}.lin-image-picker__item--3:nth-of-type(n+4){margin-top:20rpx}.lin-image-picker__item--3:not(:nth-of-type(3n+1)){margin-left:20rpx}.lin-image-picker__item--4:nth-of-type(n+5){margin-top:20rpx}.lin-image-picker__item--4:not(:nth-of-type(4n+1)){margin-left:20rpx}.lin-image-picker__item--5:nth-of-type(n+6){margin-top:20rpx}.lin-image-picker__item--5:not(:nth-of-type(5n+1)){margin-left:20rpx}.lin-image-picker__item--6:nth-of-type(n+7){margin-top:20rpx}.lin-image-picker__item--6:not(:nth-of-type(6n+1)){margin-left:20rpx}.lin-image-picker__item--7:nth-of-type(n+8){margin-top:20rpx}.lin-image-picker__item--7:not(:nth-of-type(7n+1)){margin-left:20rpx}.lin-image-picker__item--8:nth-of-type(n+9){margin-top:20rpx}.lin-image-picker__item--8:not(:nth-of-type(8n+1)){margin-left:20rpx}.lin-image-picker__item--9:nth-of-type(n+10){margin-top:20rpx}.lin-image-picker__item--9:not(:nth-of-type(9n+1)){margin-left:20rpx}.lin-image-picker__item--10:nth-of-type(n+11){margin-top:20rpx}.lin-image-picker__item--10:not(:nth-of-type(10n+1)){margin-left:20rpx}.lin-image-picker__item--null:nth-of-type(n+4){margin-top:20rpx}.lin-image-picker__item--null:not(:nth-of-type(3n+1)){margin-left:20rpx}.lin-image-picker__image{position:absolute;left:0;top:0;width:100%;height:100%;border:1rpx solid #eee;border-radius:4rpx}.lin-image-picker__remove{position:absolute;right:10rpx;top:10rpx;height:40rpx;width:40rpx;border-radius:50%;background:rgba(0,0,0,.4);display:flex;flex-direction:row;align-items:center;justify-content:center;box-sizing:border-box}.lin-image-picker__item--add{border:1rpx solid #eee;border-radius:4rpx;background-color:#fff}.lin-image-picker__image--add{visibility:hidden;position:absolute;width:50%;height:50%;top:50%;left:50%;transform:translate(-50%,-50%)}.lin-image-picker__item-slot-wrapper{display:flex;justify-content:center;align-items:center;position:absolute;width:100%;height:100%;top:0;left:0}.lin-image-picker__item-slot-wrapper:empty+.lin-image-picker__image--add{visibility:visible}
</style>